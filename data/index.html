<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 Heizungssteuerung</title>
    <meta name="description" content="Steuerung f√ºr ESP32-basierte Heizungsanlage">
    <meta name="theme-color" content="#667eea">
    <link rel="manifest" href="/manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Heizung">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="assets/css/style.css">
</head>

<body>
    <!-- Toast Notification Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Reboot/Update Overlay (shown during OTA reboot / reconnect) -->
    <div class="reboot-overlay" id="rebootOverlay">
        <div class="reboot-card">
            <div class="reboot-title">
                <div class="spinner"></div>
                <div id="rebootOverlayTitle">Update wird installiert‚Ä¶</div>
            </div>
            <div class="reboot-sub" id="rebootOverlaySub">
                Der ESP32 startet neu und ist gleich wieder erreichbar. Wir versuchen automatisch neu zu verbinden‚Ä¶
            </div>
        </div>
    </div>
    
    <!-- OTA Update Modal -->
    <div class="modal-overlay" id="otaModal">
        <div class="modal" style="max-width: 700px;">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-cloud-upload-alt" style="margin-right: 8px;"></i>
                    OTA Update
                </div>
                <button class="modal-close" onclick="closeOtaModal()">√ó</button>
            </div>
            
            <div style="padding: 20px;">
                <!-- Firmware Update Section -->
                <div
                    style="background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 16px;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                        <div
                            style="width: 40px; height: 40px; border-radius: 10px; background: rgba(52, 152, 219, 0.15); display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-microchip" style="color: #3498db; font-size: 18px;"></i>
                        </div>
                        <div>
                            <div style="font-size: 15px; font-weight: 600; color: var(--text);">Firmware Update</div>
                            <div style="font-size: 12px; color: var(--muted);">C++ Backend-Code</div>
                        </div>
                    </div>
                    
                    <div
                        style="background: rgba(255,255,255,0.02); border-left: 3px solid #3498db; padding: 10px 12px; margin-bottom: 16px; border-radius: 4px; font-size: 12px; color: var(--muted);">
                        <i class="fas fa-info-circle" style="margin-right: 6px; color: #3498db;"></i>
                        Nutze <code
                            style="background: rgba(0,0,0,0.2); padding: 2px 6px; border-radius: 3px;">pio run</code>,
                        dann <code
                            style="background: rgba(0,0,0,0.2); padding: 2px 6px; border-radius: 3px;">firmware.bin</code>
                        hochladen.
                    </div>
                    
                    <form id="otaForm" onsubmit="uploadFirmware(event)"
                        style="display: flex; flex-direction: column; gap: 12px;">
                        <label style="position: relative; cursor: pointer;">
                            <input type="file" id="firmwareFile" accept=".bin" required
                                style="position: absolute; opacity: 0; width: 0; height: 0;">
                            <div id="firmwareFileLabel"
                                style="padding: 16px; border: 2px dashed var(--border); border-radius: 8px; text-align: center; background: rgba(255,255,255,0.02); transition: all 0.2s; color: var(--muted); font-size: 13px;">
                                <i class="fas fa-file-upload" style="margin-right: 8px;"></i>
                                <span id="firmwareFileName">Datei ausw√§hlen</span>
                            </div>
                        </label>
                        
                        <button type="submit" class="btn btn-primary" id="uploadBtn" style="width: 100%;">
                            <i class="fas fa-upload" style="margin-right: 8px;"></i>
                            Firmware hochladen
                        </button>
                    </form>
                    
                    <div id="uploadProgress" style="display: none; margin-top: 16px;">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                            <div id="uploadStatus" style="font-size: 12px; color: var(--muted);"></div>
                            <div id="uploadProgressPercent"
                                style="font-size: 12px; font-weight: 600; color: var(--text);">0%</div>
                        </div>
                        <div
                            style="background: rgba(255,255,255,0.05); border-radius: 8px; height: 12px; overflow: hidden; position: relative;">
                            <div id="uploadProgressBar"
                                style="background: #3498db; height: 100%; width: 0%; transition: width 0.3s;"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Frontend Update Section -->
                <div
                    style="background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 12px; padding: 20px;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">
                        <div
                            style="width: 40px; height: 40px; border-radius: 10px; background: rgba(155, 89, 182, 0.15); display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-code" style="color: #9b59b6; font-size: 18px;"></i>
                        </div>
                        <div>
                            <div style="font-size: 15px; font-weight: 600; color: var(--text);">Frontend Update</div>
                            <div style="font-size: 12px; color: var(--muted);">HTML/CSS/JavaScript</div>
                        </div>
                    </div>
                    
                    <div
                        style="background: rgba(255,255,255,0.02); border-left: 3px solid #9b59b6; padding: 10px 12px; margin-bottom: 16px; border-radius: 4px; font-size: 12px; color: var(--muted);">
                        <i class="fas fa-info-circle" style="margin-right: 6px; color: #9b59b6;"></i>
                        Nutze <code
                            style="background: rgba(0,0,0,0.2); padding: 2px 6px; border-radius: 3px;">pio run -t buildfs</code>,
                        dann <code
                            style="background: rgba(0,0,0,0.2); padding: 2px 6px; border-radius: 3px;">littlefs.bin</code>
                        hochladen.
                    </div>
                    
                    <form id="otaFormFS" onsubmit="uploadFrontend(event)"
                        style="display: flex; flex-direction: column; gap: 12px;">
                        <label style="position: relative; cursor: pointer;">
                            <input type="file" id="frontendFile" accept=".bin" required
                                style="position: absolute; opacity: 0; width: 0; height: 0;">
                            <div id="frontendFileLabel"
                                style="padding: 16px; border: 2px dashed var(--border); border-radius: 8px; text-align: center; background: rgba(255,255,255,0.02); transition: all 0.2s; color: var(--muted); font-size: 13px;">
                                <i class="fas fa-file-upload" style="margin-right: 8px;"></i>
                                <span id="frontendFileName">Datei ausw√§hlen</span>
                            </div>
                        </label>
                        
                        <button type="submit" class="btn btn-primary" id="uploadBtnFS" style="width: 100%;">
                            <i class="fas fa-upload" style="margin-right: 8px;"></i>
                            Frontend hochladen
                        </button>
                    </form>
                    
                    <div id="uploadProgressFS" style="display: none; margin-top: 16px;">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                            <div id="uploadStatusFS" style="font-size: 12px; color: var(--muted);"></div>
                            <div id="uploadProgressPercentFS"
                                style="font-size: 12px; font-weight: 600; color: var(--text);">0%</div>
                        </div>
                        <div
                            style="background: rgba(255,255,255,0.05); border-radius: 8px; height: 12px; overflow: hidden; position: relative;">
                            <div id="uploadProgressBarFS"
                                style="background: #9b59b6; height: 100%; width: 0%; transition: width 0.3s;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Details Modal -->
    <div class="modal-overlay" id="statsModal">
        <div class="modal" style="max-width: 760px;">
            <div class="modal-header">
                <div class="modal-title">üìä Statistik Details</div>
                <button class="modal-close" onclick="closeStatsModal()">√ó</button>
            </div>

            <div class="info-box" style="font-size: 12px; margin-bottom: 12px;">
                Tageswerte werden auf dem ESP32 gespeichert (kleine Ring-History, spart Speicher). F√ºr aussagekr√§ftige
                Tages-/Wochenwerte muss NTP aktiv sein.
            </div>

            <div id="statsModalSummary"
                style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 14px;"></div>

            <div
                style="display:flex; align-items:center; justify-content: space-between; gap: 12px; margin-bottom: 10px; margin-top: 14px;">
                <div style="font-weight: 700; color: var(--text);">√úbersicht</div>
                <div style="display:flex; align-items:center; gap: 8px;">
                    <select id="statsRangeSelect" class="setting-input" style="max-width: 130px; font-size: 12px;"
                        onchange="renderStatsModal(window.__lastStatsHistory || {})">
                        <option value="7">7 Tage</option>
                        <option value="14" selected>14 Tage</option>
                    </select>
                    <button class="btn btn-secondary" onclick="refreshStatsModal()"
                        style="font-size: 12px; padding: 6px 10px;">Aktualisieren</button>
                </div>
            </div>

            <div id="statsModalDaysList" style="margin-top: 14px;"></div>
            
            <div id="statsModalSwitchEvents" style="margin-top: 20px;"></div>
        </div>
    </div>
    
    <div class="header">
        <div class="header-left">
            <h1>Heizungssteuerung</h1>
            <div class="version-badge" id="versionBadge">v0.0.0</div>
            <div class="demo-badge" id="demoBadge">DEMO</div>
        </div>
        <div class="header-right">
            <div class="header-system-info">
                <div class="header-info-item">
                    <i class="fas fa-wifi wifi-icon" id="wifiIcon"></i>
                    <span class="header-info-value" id="rssiValue">--</span>
                </div>
                <div class="header-info-item">
                    <span class="header-info-label">Uptime:</span>
                    <span class="header-info-value" id="uptimeValue">--</span>
                </div>
                <div class="header-info-item">
                    <span class="header-info-label">NTP:</span>
                    <span class="ntp-status" id="ntpStatus">--</span>
                </div>
            </div>
            <div class="theme-switch" title="Theme">
                <i class="fas fa-circle-half-stroke"></i>
                <select id="themeSelect" onchange="setThemeMode(this.value)">
                    <option value="system">System</option>
                    <option value="light">Hell</option>
                    <option value="dark">Dunkel</option>
                </select>
            </div>
            <div class="header-weather-mini" id="headerWeatherMini"
                style="display: none; font-size: 13px; color: var(--text);">
                <span id="headerWeatherIcon">üå§Ô∏è</span>
                <span id="headerWeatherTemp">--¬∞C</span>
            </div>
            <div class="current-time" id="currentTime">--:--</div>
            <div class="status-indicator">
                <div class="status-dot" id="statusDot"></div>
                <span id="connectionText">Verbinde...</span>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="left-column">
            <!-- Temperature Card -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Temperaturen</div>
                    <div class="card-badge" id="relayBadge">Aus</div>
                </div>
                <div class="temp-grid">
                    <div class="temp-item">
                        <div class="temp-value" id="tempVorlauf">--</div>
                        <div class="temp-label">Vorlauf</div>
                    </div>
                    <div class="temp-item">
                        <div class="temp-value" id="tempRuecklauf">--</div>
                        <div class="temp-label">R√ºcklauf</div>
                    </div>
                </div>
                <div class="hyst-stats">
                    <div class="hyst-item">
                        <div class="hyst-label ein">Heizung <b>EIN</b></div>
                        <div class="hyst-value" id="statTempOn">--¬∞C</div>
                    </div>
                    <div class="hyst-item">
                        <div class="hyst-label aus">Heizung <b>AUS</b></div>
                        <div class="hyst-value" id="statTempOff">--¬∞C</div>
                    </div>
                </div>
            </div>

            <!-- NEW: Efficiency Card -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Temperatur-Differenz</div>
                </div>
                <div style="text-align: center; padding: 20px 0;">
                    <div style="font-size: 42px; font-weight: 300; color: #3498db; margin-bottom: 8px;" id="tempDiff">Œî
                        --¬∞C</div>
                    <div
                        style="font-size: 13px; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 16px;">
                        Vorlauf - R√ºcklauf</div>
                    <div
                        style="width: 100%; background: var(--border); height: 24px; border-radius: 12px; overflow: hidden;">
                        <div id="efficiencyBar"
                            style="width: 0%; height: 100%; background: linear-gradient(90deg, #11998e 0%, #38ef7d 100%); transition: width 0.5s;">
                    </div>
                    </div>
                    <div style="margin-top: 8px; font-size: 14px; color: var(--text); font-weight: 600;">
                        Heizleistung: <span id="efficiencyValue">--%</span>
                    </div>
                </div>
            </div>

            <!-- Control Card -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Steuerung</div>
                    <div class="card-badge" id="modeBadge">Manuell</div>
                </div>
                
                <div class="mode-selector">
                    <button class="mode-button active" id="modeManual" onclick="setMode('manual')">Manuell</button>
                    <button class="mode-button" id="modeAuto" onclick="setMode('auto')">Automatik</button>
                    <button class="mode-button" id="modeSchedule" onclick="setMode('schedule')">Zeitplan</button>
                </div>
                
                <div class="toggle-control" id="manualControl">
                    <div class="toggle-label">Heizung</div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="heatingToggle" onchange="toggleHeating()">
                        <span class="slider"></span>
                    </label>
                </div>
                
                <div class="toggle-control" id="pumpControl" style="display: none;">
                    <div class="toggle-label">Pumpe</div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="pumpToggle" onchange="togglePump()">
                        <span class="slider"></span>
                    </label>
                </div>
                
                <div id="autoInfo" style="display: none;">
                    <div class="info-box">
                        Automatische Temperaturregelung aktiv
                        <div style="margin-top: 8px; font-size: 0.9em; color: var(--text-secondary);">
                            Heizung: <span id="autoHeatingStatus">AUS</span> | Pumpe: <span
                                id="autoPumpStatus">AUS</span>
                        </div>
                    </div>
                </div>
                
                <div id="scheduleInfo" style="display: none;">
                    <div class="info-box">
                        Zeitplansteuerung aktiv
                        <div style="margin-top: 8px; font-size: 0.9em; color: var(--text-secondary);">
                            Heizung: <span id="scheduleHeatingStatus">AUS</span> | Pumpe: <span
                                id="schedulePumpStatus">AUS</span>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border);">
                    <div class="toggle-control" style="margin-bottom: 12px;">
                        <div class="toggle-label">Frostschutz aktiv</div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="frostEnabled" onchange="saveFrostProtection()">
                            <span class="slider"></span>
                        </label>
                    </div>
                    
                    <div class="setting-item" id="frostTempSetting" style="display: none; margin-bottom: 12px;">
                        <label class="setting-label">Mindesttemperatur</label>
                        <div class="input-with-unit">
                            <input type="number" class="setting-input" id="frostTemp" value="8" min="5" max="15"
                                step="0.5" onchange="saveFrostProtection()">
                            <span class="input-unit">¬∞C</span>
                        </div>
                    </div>
                    
                    <div class="info-box" style="font-size: 12px; margin-bottom: 0;">
                        H√§lt Mindesttemperatur bei Abwesenheit. √úberschreibt alle anderen Modi.
                    </div>
                </div>
            </div>

            <!-- Settings Card (Auto) -->
            <div class="card" id="hystereseCard" style="display: none;">
                <div class="card-header">
                    <div class="card-title">Temperatur-Einstellungen</div>
                </div>
                
                <div class="setting-item">
                    <label class="setting-label">Heizung EIN</label>
                    <div class="input-with-unit">
                        <input type="number" class="setting-input" id="tempOn" value="30" step="0.5">
                        <span class="input-unit">¬∞C</span>
                    </div>
                    <div style="font-size: 11px; color: var(--muted-light); margin-top: 4px;">Heizung EIN, wenn R√ºcklauf
                        ‚â§ dieser Temperatur</div>
                </div>
                
                <div class="setting-item">
                    <label class="setting-label">Heizung AUS</label>
                    <div class="input-with-unit">
                        <input type="number" class="setting-input" id="tempOff" value="40" step="0.5">
                        <span class="input-unit">¬∞C</span>
                    </div>
                    <div style="font-size: 11px; color: var(--muted-light); margin-top: 4px;">Heizung AUS, wenn R√ºcklauf
                        ‚â• dieser Temperatur</div>
                </div>
                
                <div id="hystereseWarning" class="info-box warning" style="display: none; margin: 12px 0;">
                    AUS-Temperatur muss h√∂her sein!
                </div>
                
                <button class="btn btn-primary" onclick="saveSettings()">Speichern</button>
            </div>

            <!-- Schedule Card -->
            <div class="card" id="scheduleCard" style="display: none;">
                <div class="card-header">
                    <div class="card-title">Zeitplan konfigurieren</div>
                </div>
                
                <div id="scheduleList"></div>
                
                <button class="btn btn-primary" onclick="saveSettings()" style="margin-top: 12px;">Zeitplan
                    speichern</button>
            </div>

            <!-- NEW: Relay Configuration Card (Advanced) -->
            <div class="card" id="relayConfigCard" data-collapse-default="collapsed">
                <div class="card-header">
                    <div class="card-title">Relais-Einstellungen (Erweitert)</div>
                </div>

                <div class="info-box" style="font-size: 12px; margin-bottom: 12px;">
                    Falls ein Relais im AUS-Zustand leicht glimmt oder nicht sauber schaltet, kann es helfen, das
                    OFF-Verhalten umzustellen.
                    Standard ist <b>Active-Low</b> + <b>Open-Drain OFF</b> (floating).
                </div>

                <div style="font-weight: 600; margin: 6px 0 10px; color: var(--text);">Heizung</div>
                <div class="toggle-control" style="margin-bottom: 10px;">
                    <div class="toggle-label">Heizungsrelais Active-Low (LOW = EIN)</div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="heaterRelayActiveLow" onchange="saveRelayConfig()">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="setting-item" style="margin-bottom: 16px;">
                    <label class="setting-label">Heizungsrelais OFF-Modus</label>
                    <select class="setting-input" id="heaterRelayOffMode" onchange="saveRelayConfig()">
                        <option value="0">OUTPUT HIGH (3.3V)</option>
                        <option value="1">OPEN-DRAIN HIGH</option>
                        <option value="2">INPUT (Hi-Z)</option>
                    </select>
                </div>

                <div style="font-weight: 600; margin: 6px 0 10px; color: var(--text);">Pumpe</div>
                <div class="toggle-control" style="margin-bottom: 10px;">
                    <div class="toggle-label">Pumpenrelais Active-Low (LOW = EIN)</div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="pumpRelayActiveLow" onchange="saveRelayConfig()">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="setting-item" style="margin-bottom: 0;">
                    <label class="setting-label">Pumpenrelais OFF-Modus</label>
                    <select class="setting-input" id="pumpRelayOffMode" onchange="saveRelayConfig()">
                        <option value="0">OUTPUT HIGH (3.3V)</option>
                        <option value="1">OPEN-DRAIN HIGH</option>
                        <option value="2">INPUT (Hi-Z)</option>
                    </select>
                </div>
            </div>
            
            <!-- NEW: Location Settings Card -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Standort-Einstellungen</div>
                </div>
                
                <div class="setting-item">
                    <label class="setting-label">Stadt oder Postleitzahl</label>
                    <input type="text" class="setting-input" id="locationInput" placeholder="z.B. Berlin oder 10115"
                        value="">
                </div>
                
                <div class="info-box" style="font-size: 12px; margin-top: 12px;" id="locationInfo">
                    <i class="fas fa-map-marker-alt"></i> Standort f√ºr Wetterdaten. Aktuell: <span
                        id="currentLocationName">-</span>
                </div>
                
                <button class="btn btn-primary" id="saveLocationBtn" onclick="saveLocationByName()"
                    style="margin-top: 12px;">
                    <i class="fas fa-search" id="saveLocationIcon"></i> <span id="saveLocationText">Standort suchen &
                        speichern</span>
                </button>
                
                <!-- Hidden fields for actual coordinates -->
                <input type="hidden" id="latitude" value="50.952149">
                <input type="hidden" id="longitude" value="7.1229">
            </div>
        </div>

        <div class="right-column">
            <!-- NEW: Weather Card -->
            <div class="card" id="weatherCard">
                <div class="card-header collapsible">
                    <div class="card-title">
                        <i class="fas fa-chevron-right collapse-arrow"></i>
                        <span id="weatherTitle">üå§Ô∏è Wetter</span>
                    </div>
                    <div class="card-subtitle" id="weatherLocation" style="font-size: 12px; color: var(--muted-light);">
                    </div>
                </div>
                
                <div class="card-content expanded" id="weatherContent">
                    <div class="weather-error" id="weatherErrorMsg">Bitte zuerst einen Standort in den Einstellungen
                        eintragen, um Wetterdaten abzurufen.</div>
                </div>
            </div>
            
            <!-- Serial Monitor Card -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Serial Monitor</div>
                    <label class="toggle-switch" style="margin-left: auto;">
                        <input type="checkbox" id="serialAutoScroll" checked>
                        <span class="slider"></span>
                    </label>
                    <span style="font-size: 12px; color: var(--muted); margin-left: 8px;">Auto-Scroll</span>
                </div>
                
                <div id="serialMonitor"
                    style="background: #1e1e1e; color: #d4d4d4; font-family: 'Courier New', monospace; font-size: 11px; padding: 12px; border-radius: 6px; height: 300px; overflow-y: auto; line-height: 1.4; word-break: break-all;">
                    <div style="color: #608b4e;">// Warte auf Verbindung...</div>
                </div>
                
                <div style="display: flex; gap: 8px; margin-top: 12px;">
                    <button class="btn btn-secondary" onclick="clearSerialMonitor()"
                        style="flex: 1; font-size: 12px; padding: 6px 12px;">Log l√∂schen</button>
                    <button class="btn btn-secondary" onclick="openOtaModal()"
                        style="flex: 1; font-size: 12px; padding: 6px 12px;">
                        <i class="fas fa-upload"></i> OTA Update
                    </button>
                </div>
            </div>
            
            <!-- NEW: Tank Level Card -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Tankinhalt</div>
                </div>
                
                <div id="tankAvailableContainer">
                    <!-- Visual tank display -->
                    <div style="text-align: center; padding: 20px 0;">
                        <div style="font-size: 48px; font-weight: 300; color: #3498db; margin-bottom: 8px;"
                            id="tankLiters">-- L</div>
                        <div
                            style="font-size: 13px; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 16px;">
                            Verbleibend</div>
                        
                        <!-- Tank visualization -->
                        <div
                            style="width: 100%; max-width: 200px; height: 200px; border: 3px solid #3498db; border-radius: 8px; margin: 0 auto; position: relative; overflow: hidden; background: rgba(52, 152, 219, 0.1);">
                            <div id="tankFillBar"
                                style="position: absolute; bottom: 0; width: 100%; height: 0%; background: linear-gradient(180deg, #3498db 0%, #2980b9 100%); transition: height 0.5s, background 0.5s;">
                            </div>
                            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 32px; font-weight: 600; color: var(--text); z-index: 10; text-shadow: 0 0 10px rgba(255,255,255,0.8);"
                                id="tankPercent">--%</div>
                        </div>
                        
                        <div id="tankWarning"
                            style="margin-top: 12px; padding: 8px; background: #e74c3c; color: white; border-radius: 6px; font-size: 13px; font-weight: 600; display: none;">
                            ‚ö†Ô∏è Niedriger F√ºllstand!
                        </div>
                    </div>
                    
                    <!-- Tank settings -->
                    <div style="border-top: 1px solid #ecf0f1; padding-top: 16px; margin-top: 8px;">
                        <div class="setting-item">
                            <label class="setting-label">Tankh√∂he</label>
                            <div class="input-with-unit">
                                <input type="number" class="setting-input" id="tankHeight" value="100" min="10"
                                    max="500" step="1" onchange="saveTankConfig()">
                                <span class="input-unit">cm</span>
                            </div>
                        </div>
                        
                        <div class="setting-item">
                            <label class="setting-label">Tankkapazit√§t</label>
                            <div class="input-with-unit">
                                <input type="number" class="setting-input" id="tankCapacity" value="1000" min="10"
                                    max="10000" step="10" onchange="saveTankConfig()">
                                <span class="input-unit">Liter</span>
                            </div>
                        </div>
                        
                        <div class="setting-item">
                            <label class="setting-label">Dieselverbrauch</label>
                            <div class="input-with-unit">
                                <input type="number" class="setting-input" id="dieselConsumptionPerHour" value="2.0"
                                    min="0.1" max="20" step="0.1" onchange="saveTankConfig()">
                                <span class="input-unit">L/h</span>
                            </div>
                            <div style="font-size: 11px; color: var(--muted); margin-top: 4px;">Verbrauch pro Stunde bei
                                laufender Heizung</div>
                        </div>
                        
                        <div class="info-box" style="font-size: 11px;">
                            Sensor misst Abstand von oben zur Fl√ºssigkeit. Konfiguriere Tankh√∂he und Kapazit√§t f√ºr
                            korrekte Anzeige.
                        </div>
                    </div>
                </div>
                
                <div id="tankNotAvailableContainer" style="display: none; text-align: center; padding: 40px 20px;">
                    <div style="font-size: 48px; color: var(--muted-light); margin-bottom: 12px;">‚ö†Ô∏è</div>
                    <div style="font-size: 16px; font-weight: 600; color: var(--muted); margin-bottom: 8px;">Sensor
                        nicht verf√ºgbar</div>
                    <div style="font-size: 13px; color: var(--muted-light);">JSN-SR04T nicht erkannt oder nicht
                        angeschlossen</div>
                </div>
            </div>
            
            <!-- Behavior Warning -->
            <div class="card" id="behaviorWarningCard" style="display: none;">
                <div class="card-header" style="border-bottom: 2px solid #e74c3c;">
                    <div class="card-title" style="color: #e74c3c;">
                        <i class="fas fa-exclamation-triangle"></i> Warnung: Ungew√∂hnliches Verhalten
                    </div>
                </div>
                <div style="padding: 16px;">
                    <div class="info-box warning" style="background: rgba(231, 76, 60, 0.1); border-color: #e74c3c;">
                        <strong>Zu h√§ufiges Schalten erkannt!</strong><br>
                        Die Heizung hat in den letzten 15 Minuten mehr als 10 Mal geschaltet. Dies k√∂nnte auf ein
                        Problem hinweisen (z.B. defekter Thermostat, falsche Einstellungen, Sensoren-Fehler).<br><br>
                        <strong>Bitte pr√ºfen:</strong>
                        <ul style="margin: 8px 0 0 20px; padding: 0;">
                            <li>Temperatursensoren funktionieren korrekt?</li>
                            <li>Hysterese-Einstellungen (EIN/AUS-Temperaturen) sinnvoll?</li>
                            <li>Thermostat oder Regler defekt?</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- Backup & Restore -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">üíæ Backup & Restore</div>
                </div>
                
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <button class="btn btn-secondary" onclick="exportSettings()" style="width: 100%;">
                        <i class="fas fa-download"></i> Einstellungen exportieren
                    </button>
                    
                    <label class="btn btn-secondary" style="width: 100%; cursor: pointer; text-align: center;">
                        <i class="fas fa-upload"></i> Einstellungen importieren
                        <input type="file" id="importFileInput" accept=".json" style="display: none;"
                            onchange="importSettings(event)">
                    </label>
                    
                    <div class="info-box" style="font-size: 12px; margin-top: 8px;">
                        <i class="fas fa-info-circle"></i> Exportiert alle Einstellungen (Modus, Temperaturen,
                        Zeitpl√§ne, Relais-Konfiguration) als JSON-Datei. Import √ºberschreibt aktuelle Einstellungen.
                    </div>
                </div>
            </div>
            
            <!-- Telegram Notifications -->
            <div class="card">
                <div class="card-body">
                    <div class="card-header">
                        <div class="card-title">üì± Telegram-Benachrichtigungen</div>
                    </div>
                    
                    <div class="info-box" style="font-size: 12px; margin-bottom: 12px;">
                        <i class="fas fa-info-circle"></i> Telegram-Bot Token muss in <code>secrets.h</code> eingetragen
                        werden. Chat ID: <strong>265523534</strong>
                    </div>
                    
                    <button class="btn btn-primary" onclick="sendTelegramTest()" id="telegramTestBtn">
                        <i class="fas fa-paper-plane"></i> Test-Nachricht senden
                    </button>
                    
                    <div class="info-box" style="font-size: 12px; margin-top: 12px;">
                        <strong>Automatische Benachrichtigungen:</strong><br>
                        üî• Heizung EIN/AUS<br>
                        ‚ö†Ô∏è Sensor-Fehler<br>
                        ü™´ Tank niedrig (&lt; 20%)<br>
                        ‚úÖ Sensoren wieder OK<br>
                        ‚ö†Ô∏è Ungew√∂hnliches Verhalten (zu h√§ufiges Schalten)
                    </div>
                </div>
            </div>
            
            <!-- NEW: Statistics Card -->
            <div class="card" id="statisticsCard">
                <div class="card-header collapsible">
                    <div class="card-title">
                        <i class="fas fa-chevron-right collapse-arrow" id="statisticsArrow"></i>
                        <span id="statisticsTitle">Statistik</span>
                    </div>
                </div>
                
                <div class="card-content collapsed" id="statisticsContent">
                    <!-- Kompakte Statistik-√úbersicht -->
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 16px;">
                        <div
                            style="background: rgba(255,255,255,0.04); border: 1px solid var(--border); border-radius: 8px; padding: 12px; text-align: center;">
                            <div
                                style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px;">
                                Heute</div>
                            <div style="font-size: 20px; font-weight: 700; color: var(--text);"
                                id="todaySwitchesCompact">0x</div>
                        </div>
                        <div
                            style="background: rgba(255,255,255,0.04); border: 1px solid var(--border); border-radius: 8px; padding: 12px; text-align: center;">
                            <div
                                style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px;">
                                Gesamt</div>
                            <div style="font-size: 20px; font-weight: 700; color: var(--text);"
                                id="totalSwitchesCompact">0x</div>
                        </div>
                        <div
                            style="background: rgba(255,255,255,0.04); border: 1px solid var(--border); border-radius: 8px; padding: 12px; text-align: center;">
                            <div
                                style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px;">
                                Heizung ON</div>
                            <div style="font-size: 16px; font-weight: 600; color: var(--text);" id="onTimeCompact">0h 0m
                        </div>
                        </div>
                        <div
                            style="background: rgba(255,255,255,0.04); border: 1px solid var(--border); border-radius: 8px; padding: 12px; text-align: center;">
                            <div
                                style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px;">
                                Heizung OFF</div>
                            <div style="font-size: 16px; font-weight: 600; color: var(--text);" id="offTimeCompact">0h
                                0m</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 16px;">
                        <button class="btn btn-secondary" onclick="openStatsModal(event)"
                            style="width: 100%; font-size: 12px; padding: 8px;">
                            <i class="fas fa-chart-bar"></i> Detaillierte Statistiken anzeigen
                        </button>
                    </div>
                </div>
            </div>

            <!-- Demo Controls -->
            <div class="card demo-controls" id="demoControls">
                <div class="card-header">
                    <div class="card-title">Demo</div>
                </div>
                <div class="demo-button-group">
                    <button class="demo-button" onclick="simulateSensorError()">Sensorfehler</button>
                    <button class="demo-button" onclick="simulateTempChange()">Temp √§ndern</button>
                    <button class="demo-button" onclick="simulateSchedule()">Zeitplan</button>
                    <button class="demo-button" onclick="resetDemo()">Reset</button>
                </div>
            </div>
        </div>
    </div>

    <script src="assets/js/script.js"></script>
</body>

</html>